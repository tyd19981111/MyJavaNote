# Redisåº”ç”¨é—®é¢˜è§£å†³

# 1. ç¼“å­˜ç©¿é€

## 1.1 é—®é¢˜æè¿°

![Untitled](Redis%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%20f211d11b33ef4d7097c117fe954da1e9/Untitled.png)

- å‡ºç°å¾ˆå¤šéæ­£å¸¸çš„`URL`è®¿é—®ï¼ˆä¾‹å¦‚é»‘å®¢æ”»å‡»ï¼‰
- æ­¤æ—¶æŸ¥è¯¢çš„æ•°æ®åœ¨redisç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨
    
    <aside>
    â¡ï¸ è®¿é—®è¯·æ±‚åœ¨redisä¸­æŸ¥è¯¢ä¸åˆ°æ•°æ®ï¼šrediså‘½ä¸­ç‡é™ä½
    
    </aside>
    
- è‹¥é»‘å®¢åˆ©ç”¨æ­¤æ¼æ´è¿›è¡Œæ”»å‡»å¯èƒ½å‹å®æ•°æ®åº“

## 1.2 è§£å†³æ–¹æ¡ˆ

- **å¯¹ç©ºå€¼ç¼“å­˜**
    - å¦‚æœä¸€ä¸ªæŸ¥è¯¢è¿”å›çš„æ•°æ®ä¸ºç©ºï¼ˆä¸ç®¡æ˜¯æ•°æ®æ˜¯å¦ä¸å­˜åœ¨ï¼‰ï¼Œæˆ‘ä»¬ä»ç„¶æŠŠè¿™ä¸ªç©ºç»“æœï¼ˆnullï¼‰è¿›è¡Œç¼“å­˜ï¼Œè®¾ç½®ç©ºç»“æœçš„è¿‡æœŸæ—¶é—´ä¼šå¾ˆçŸ­
- **è®¾ç½®å¯è®¿é—®çš„åå•ï¼ˆç™½åå•ï¼‰**
    - ä½¿ç”¨`bitmaps`ç±»å‹å®šä¹‰ä¸€ä¸ªå¯ä»¥è®¿é—®çš„åå•ï¼›æ¯æ¬¡è®¿é—®å’Œbitmapé‡Œé¢çš„idè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœè®¿é—®idä¸åœ¨bitmapsé‡Œé¢ï¼Œè¿›è¡Œæ‹¦æˆªï¼Œä¸å…è®¸è®¿é—®
- **é‡‡ç”¨å¸ƒéš†è¿‡æ»¤å™¨**
    - å°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„bitmapsä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ä¼šè¢«è¿™ä¸ªbitmapsæ‹¦æˆªæ‰ï¼Œä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ›
- **è¿›è¡Œå®æ—¶ç›‘æ§**
    - å½“å‘ç°Redisçš„å‘½ä¸­ç‡å¼€å§‹æ€¥é€Ÿé™ä½ï¼Œå¯ä»¥æ’æŸ¥è®¿é—®å¯¹è±¡å’Œè®¿é—®çš„æ•°æ®ï¼Œå’Œè¿ç»´äººå‘˜é…åˆï¼Œå¯ä»¥è®¾ç½®é»‘åå•é™åˆ¶æœåŠ¡

# 2. **ç¼“å­˜å‡»ç©¿**

## 2.1 é—®é¢˜æè¿°

![Untitled](Redis%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%20f211d11b33ef4d7097c117fe954da1e9/Untitled%201.png)

- redisç¼“å­˜ä¸­æŸä¸€ä¸ªkeyè¿‡æœŸäº†ï¼Œè€Œæ°å·§æ­¤æ—¶ç”¨æˆ·å¤§é‡è®¿é—®è¿™ä¸ªkey
- æœåŠ¡å™¨è¢«è¿«ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œé€ æˆæ•°æ®åº“è®¿é—®å‹åŠ›ç¬æ—¶å¢åŠ 

<aside>
â¡ï¸ æ­¤æ—¶redisæ²¡æœ‰å‡ºç°å¤§é‡çš„keyè¿‡æœŸï¼Œä¾ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œ

</aside>

## 2.2 è§£å†³æ–¹æ¡ˆ

- **é¢„å…ˆè®¾ç½®çƒ­é—¨æ•°æ®**
    - åœ¨redisé«˜å³°è®¿é—®ä¹‹å‰ï¼ŒæŠŠä¸€äº›çƒ­é—¨æ•°æ®æå‰å­˜å…¥åˆ°redisé‡Œé¢ï¼ŒåŠ å¤§è¿™äº›çƒ­é—¨æ•°æ®keyçš„æ—¶é•¿
- **å®æ—¶è°ƒæ•´**
    - ç°åœºç›‘æ§å“ªäº›æ•°æ®çƒ­é—¨ï¼Œå®æ—¶è°ƒæ•´keyçš„è¿‡æœŸæ—¶é•¿
- **ä½¿ç”¨é”**
    - å¦‚ä¸‹å›¾æ‰€ç¤º

![Untitled](Redis%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%20f211d11b33ef4d7097c117fe954da1e9/Untitled%202.png)

# 3. ç¼“å­˜é›ªå´©

## 3.1 é—®é¢˜æè¿°

![Untitled](Redis%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%20f211d11b33ef4d7097c117fe954da1e9/Untitled%203.png)

- åœ¨æå°‘çš„æ—¶é—´æ®µå†…ï¼Œredisä¸­å­˜åœ¨å¤§é‡keyé›†ä¸­è¿‡æœŸçš„æƒ…å†µï¼›æ­¤æ—¶å¤§é‡å¹¶å‘æŸ¥è¯¢ä¼šé€ æˆæ•°æ®åº“å´©æºƒ

## 3.2 è§£å†³æ–¹æ¡ˆ

- **æ„å»ºå¤šçº§ç¼“å­˜æ¶æ„**
    - nginxç¼“å­˜ + redisç¼“å­˜ +å…¶ä»–ç¼“å­˜ï¼ˆehcacheç­‰ï¼‰
- **ä½¿ç”¨é”æˆ–é˜Ÿåˆ—**
    - ç”¨åŠ é”æˆ–è€…é˜Ÿåˆ—çš„æ–¹å¼æ¥ä¿è¯ä¸ä¼šæœ‰å¤§é‡çš„çº¿ç¨‹å¯¹æ•°æ®åº“ä¸€æ¬¡æ€§è¿›è¡Œè¯»å†™ï¼Œä»è€Œé¿å…å¤±æ•ˆæ—¶å¤§é‡çš„å¹¶å‘è¯·æ±‚è½åˆ°åº•å±‚å­˜å‚¨ç³»ç»Ÿä¸Š
    
    <aside>
    ğŸ“¢ ä¸é€‚ç”¨é«˜å¹¶å‘æƒ…å†µï¼ˆé”ä¼šé™ä½æŸ¥è¯¢é€Ÿåº¦ï¼‰
    
    </aside>
    
- **è®¾ç½®è¿‡æœŸæ ‡å¿—æ›´æ–°ç¼“å­˜**
    - è®°å½•ç¼“å­˜æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆè®¾ç½®æå‰é‡ï¼‰ï¼Œå¦‚æœè¿‡æœŸä¼šè§¦å‘é€šçŸ¥å¦å¤–çš„çº¿ç¨‹åœ¨åå°å»æ›´æ–°å®é™…keyçš„ç¼“å­˜
- **å°†ç¼“å­˜å¤±æ•ˆæ—¶é—´åˆ†æ•£å¼€**
    - å¯ä»¥åœ¨åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼Œæ¯”å¦‚1-5åˆ†é’Ÿéšæœºï¼›
    - è¿™æ ·æ¯ä¸€ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´çš„é‡å¤ç‡å°±ä¼šé™ä½ï¼Œå°±å¾ˆéš¾å¼•å‘é›†ä½“å¤±æ•ˆçš„äº‹ä»¶

# 4. åˆ†å¸ƒå¼é”

## 4.1 é—®é¢˜æè¿°

- éšç€ä¸šåŠ¡å‘å±•çš„éœ€è¦ï¼ŒåŸå•ä½“å•æœºéƒ¨ç½²çš„ç³»ç»Ÿè¢«æ¼”åŒ–æˆåˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²çš„ç³»ç»Ÿ
- åŸå•æœºéƒ¨ç½²æƒ…å†µä¸‹çš„å¤šçº¿ç¨‹å¹¶å‘æ§åˆ¶é”ç­–ç•¥åœ¨åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²çš„æƒ…å†µä¸‹å¤±æ•ˆ
- ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å°±éœ€è¦ä¸€ç§è·¨JVMçš„äº’æ–¥æœºåˆ¶æ¥æ§åˆ¶å…±äº«èµ„æºçš„è®¿é—®ï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”è¦è§£å†³çš„é—®é¢˜

## 4.2 ä¸»æµè§£å†³æ–¹æ¡ˆ

- åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”
- åŸºäºç¼“å­˜ï¼ˆRedisç­‰ï¼‰
- åŸºäºZookeeper

<aside>
ğŸ“¢ redisæ€§èƒ½æœ€é«˜ï¼›zookeeperæœ€å¯é 

</aside>

## 4.3 rediså®ç°åˆ†å¸ƒå¼é”

- ç›¸å…³å‘½ä»¤
    - `setnx k1 10#åŠ é”`ï¼šè®¾ç½®k1çš„å€¼ä¸º10å¹¶åŠ é”
    - `del k1`ï¼šé‡Šæ”¾é”
    - `expire k1 10`ï¼šè®¾ç½®k1é”çš„è¿‡æœŸæ—¶é—´10s
    - `set k1 10 nx ex 12`ï¼šè®¾ç½®k1å€¼ä¸º10å¹¶ä¸Šé”ï¼ŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´12s
    - `ttl k1`ï¼šæŸ¥çœ‹k1é”çš„è¿‡æœŸæ—¶é—´
    
    <aside>
    ğŸ“¢ å¦‚æœé‡‡ç”¨å…ˆåŠ é”åç”¨expireè®¾ç½®è¿‡æœŸæ—¶é—´çš„æ–¹å¼ï¼Œä¼šå¯¼è‡´ç¼ºä¹åŸå­æ€§çš„é—®é¢˜ï¼›
    
    ä¾‹å¦‚setnxå’Œexpireä¹‹é—´å‡ºç°å¼‚å¸¸ï¼Œå°†å¯¼è‡´é”æ— æ³•é‡Šæ”¾
    
    æ¨èåœ¨åŠ é”æ—¶æŒ‡å®šè¿‡æœŸæ—¶é—´
    
    </aside>
    
- æµç¨‹å›¾åˆ†æ
    
    ![Untitled](Redis%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%20f211d11b33ef4d7097c117fe954da1e9/Untitled%204.png)
    
    - å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è·å–é”ï¼ˆsetnxï¼‰
    - è·å–æˆåŠŸï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼›æ‰§è¡Œå®Œæˆé‡Šæ”¾é”ï¼ˆdelï¼‰
    - è·å–å¤±è´¥ï¼Œç­‰å¾…é‡è¯•
- Javaå®ç°
    - åŸºæœ¬å®ç°
        
        ```java
        @GetMapping("testLock")
        public void testLock(){
            //1è·å–é”ï¼Œsetne
            Boolean lock = redisTemplate.opsForValue().setIfAbsent("lock", "111");
            //2è·å–é”æˆåŠŸã€æŸ¥è¯¢numçš„å€¼
            if(lock){
                Object value = redisTemplate.opsForValue().get("num");
                //2.1åˆ¤æ–­numä¸ºç©ºreturn
                if(StringUtils.isEmpty(value)){
                    return;
                }
                //2.2æœ‰å€¼å°±è½¬æˆæˆint
                int num = Integer.parseInt(value+"");
                //2.3æŠŠredisçš„numåŠ 1
                redisTemplate.opsForValue().set("num", ++num);
        				//2.4é‡Šæ”¾é”ï¼Œdel
                redisTemplate.delete("lock");
        
            }else{
                //3è·å–é”å¤±è´¥ã€æ¯éš”0.1ç§’å†è·å–
                try {
                    Thread.sleep(100);
                    testLock();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
        ```
        
    - é‡å¯æœåŠ¡é›†ç¾¤ï¼Œè¿›è¡Œç½‘å…³å‹åŠ›æµ‹è¯•ï¼ˆabæµ‹è¯•ï¼‰
        
        ```bash
        ab -n 1000 -c 100 http://192.168.140.1:8080/test/testLock
        ```
        

# 5. åˆ†å¸ƒå¼é”ä¼˜åŒ–

## 5.1 ä¼˜åŒ–ä¹‹è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´

```java
//ä¿®æ”¹ä¸Šè¿°æ¡ˆä¾‹ä»£ç ,è®¾ç½®è¿‡æœŸæ—¶é—´3s
Boolean lock = redisTemplate.opsForValue().setIfAbsent("lock", "111",3,TimeUnit.SECONDS);
```

## 5.2 **ä¼˜åŒ–ä¹‹UUIDé˜²è¯¯åˆ **

- è¯¯åˆ é—®é¢˜æè¿°
    
    ![Untitled](Redis%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%20f211d11b33ef4d7097c117fe954da1e9/Untitled%205.png)
    
- è§£å†³æ–¹æ¡ˆ
    - ç¬¬ä¸€æ­¥ï¼ŒUUIDè¡¨ç¤ºä¸åŒçš„æ“ä½œ
        
        `set lock uuid nx ex 10`
        
    - ç¬¬äºŒæ­¥ï¼Œé‡Šæ”¾é”çš„æ—¶å€™ï¼Œåˆ¤æ–­å½“å‰çš„UUIDå’Œè¦é‡Šæ”¾é”çš„UUIDæ˜¯å¦ä¸€æ ·
- ä»£ç å®ç°
    
    ```java
    public void testLock( 
    //1.ä»redisä¸­è·å–é”.setnx
    String uuid = UUID.randomUUID().toString();
    Boolean lock = this.redisTemplate.opsForValue().setIfAbsent(k "1ock", uuid,I: 2ï¼ŒTimeUnit.SECONDS);
    if(lock) {
    	//æŸ¥è¯¢redisä¸­çš„num å€¼
    	String value = this.redisTemplate.opsForValue().get("num" );1/æ²¡æœ‰è¯¥å€¼return
    	if (StringUtils.isBLank(value)){
    	return ;
    	}
    	//æœ‰å€¼å°±è½¬æˆæˆint
    	int num = Integer.parseInt(value);
    	//æŠŠredisä¸­çš„num lå€¼+1
    	this.redisTemplate.opsForValue().set("num" ,String. valueOf(++num));
    	if(uuid.equals((String)redisTemplate.opsForValue().get("lock"))) {
    		this.redisTemplate.delete(key: "1ock");
    	}
    }else{...}
    ```
    

## 5.3 **ä¼˜åŒ–ä¹‹LUAè„šæœ¬ä¿è¯åˆ é™¤çš„åŸå­æ€§**

- é—®é¢˜æè¿°
    
    ![Untitled](Redis%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%20f211d11b33ef4d7097c117fe954da1e9/Untitled%206.png)
    
- è§£å†³æ–¹æ¡ˆ
    - ä½¿ç”¨Luaè„šæœ¬ï¼ˆLuaå…·æœ‰åŸå­æ€§ï¼‰
- ä»£ç å®ç°
    
    ```java
    @GetMapping("testLockLua")
    public void testLockLua() {
        //1 å£°æ˜ä¸€ä¸ªuuid ,å°†åšä¸ºä¸€ä¸ªvalue æ”¾å…¥æˆ‘ä»¬çš„keyæ‰€å¯¹åº”çš„å€¼ä¸­
        String uuid = UUID.randomUUID().toString();
        //2 å®šä¹‰ä¸€ä¸ªé”ï¼šlua è„šæœ¬å¯ä»¥ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œæ¥å®ç°åˆ é™¤ï¼
        String skuId = "25"; // è®¿é—®skuId ä¸º25å·çš„å•†å“ 100008348542
        String locKey = "lock:" + skuId; // é”ä½çš„æ˜¯æ¯ä¸ªå•†å“çš„æ•°æ®
    
        // 3 è·å–é”
        Boolean lock = redisTemplate.opsForValue().setIfAbsent(locKey, uuid, 3, TimeUnit.SECONDS);
    
        // ç¬¬ä¸€ç§ï¼š lock ä¸è¿‡æœŸæ—¶é—´ä¸­é—´ä¸å†™ä»»ä½•çš„ä»£ç ã€‚
        // redisTemplate.expire("lock",10, TimeUnit.SECONDS);//è®¾ç½®è¿‡æœŸæ—¶é—´
        // å¦‚æœtrue
        if (lock) {
            // æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘å¼€å§‹
            // è·å–ç¼“å­˜ä¸­çš„num æ•°æ®
            Object value = redisTemplate.opsForValue().get("num");
    				// å¦‚æœæ˜¯ç©ºç›´æ¥è¿”å›
            if (StringUtils.isEmpty(value)) {
                return;
            }
            // ä¸æ˜¯ç©º å¦‚æœè¯´åœ¨è¿™å‡ºç°äº†å¼‚å¸¸ï¼ é‚£ä¹ˆdelete å°±åˆ é™¤å¤±è´¥ï¼ ä¹Ÿå°±æ˜¯è¯´é”æ°¸è¿œå­˜åœ¨ï¼
            int num = Integer.parseInt(value + "");
            // ä½¿num æ¯æ¬¡+1 æ”¾å…¥ç¼“å­˜
            redisTemplate.opsForValue().set("num", String.valueOf(++num));
            /*ä½¿ç”¨luaè„šæœ¬æ¥é”*/
            // å®šä¹‰lua è„šæœ¬
            String script = "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end";
            // ä½¿ç”¨redisæ‰§è¡Œluaæ‰§è¡Œ
            DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
            redisScript.setScriptText(script);
            // è®¾ç½®ä¸€ä¸‹è¿”å›å€¼ç±»å‹ ä¸ºLong
            // å› ä¸ºåˆ é™¤åˆ¤æ–­çš„æ—¶å€™ï¼Œè¿”å›çš„0,ç»™å…¶å°è£…ä¸ºæ•°æ®ç±»å‹ã€‚å¦‚æœä¸å°è£…é‚£ä¹ˆé»˜è®¤è¿”å›String ç±»å‹ï¼Œ
            // é‚£ä¹ˆè¿”å›å­—ç¬¦ä¸²ä¸0 ä¼šæœ‰å‘ç”Ÿé”™è¯¯ã€‚
            redisScript.setResultType(Long.class);
            // ç¬¬ä¸€ä¸ªè¦æ˜¯script è„šæœ¬ ï¼Œç¬¬äºŒä¸ªéœ€è¦åˆ¤æ–­çš„keyï¼Œç¬¬ä¸‰ä¸ªå°±æ˜¯keyæ‰€å¯¹åº”çš„å€¼ã€‚
            redisTemplate.execute(redisScript, Arrays.asList(locKey), uuid);
        } else {
            // å…¶ä»–çº¿ç¨‹ç­‰å¾…
            try {
                // ç¡çœ 
                Thread.sleep(1000);
                // ç¡é†’äº†ä¹‹åï¼Œè°ƒç”¨æ–¹æ³•ã€‚
                testLockLua();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
    ```