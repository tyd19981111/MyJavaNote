# redisæ–°æ•°æ®ç±»å‹

# 1. Bitmaps

## 1.1 ç®€ä»‹

![Untitled](redis%E6%96%B0%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%200283eaf46b524244b24bad15862290c5/Untitled.png)

- å¯ä»¥æŠŠBitmapsæƒ³è±¡æˆä¸€ä¸ªä»¥ä½ä¸ºå•ä½çš„æ•°ç»„ï¼Œ æ•°ç»„çš„æ¯ä¸ªå•å…ƒåªèƒ½å­˜å‚¨0å’Œ1ï¼Œ æ•°ç»„çš„ä¸‹æ ‡åœ¨Bitmapsä¸­å«åšåç§»é‡ï¼ˆoffsetï¼‰

## 1.2 å‘½ä»¤

- `setbit <key> <offset> <value>`ï¼šè®¾ç½®Bitmapsä¸­æŸä¸ªåç§»é‡çš„å€¼ï¼ˆ0æˆ–1ï¼‰
    
    <aside>
    ğŸ“¢ offset:åç§»é‡ä»0å¼€å§‹
    
    </aside>
    
- `getbit <key> <offset>`ï¼šè·å–Bitmapsä¸­æŸä¸ªåç§»é‡çš„å€¼
- `bitcount <key> [start end]` ï¼šç»Ÿè®¡å­—ç¬¦ä¸²ä»startå­—èŠ‚åˆ°endå­—èŠ‚æ¯”ç‰¹å€¼ä¸º1çš„æ•°é‡
    
    <aside>
    ğŸ“¢ è¿™é‡Œçš„startå’Œendå¯¹åº”byteå­—èŠ‚ä½ï¼Œè€Œä¸æ˜¯bitä½
    
    </aside>
    
- `bitop and(or/not/xor) <destkey> [keyâ€¦]`ï¼šbitopæ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼Œ å®ƒå¯ä»¥åšå¤šä¸ªBitmapsçš„andï¼ˆäº¤é›†ï¼‰ã€orï¼ˆå¹¶é›†ï¼‰ã€notï¼ˆéï¼‰ã€ xorï¼ˆå¼‚æˆ–ï¼‰æ“ä½œå¹¶å°†ç»“æœä¿å­˜åœ¨destkeyä¸­

## 1.3 å®ä¾‹

- æ¯ä¸ªç‹¬ç«‹ç”¨æˆ·æ˜¯å¦è®¿é—®è¿‡ç½‘ç«™å­˜æ”¾åœ¨Bitmapsä¸­ï¼Œ å°†è®¿é—®çš„ç”¨æˆ·è®°åš1ï¼Œ æ²¡æœ‰è®¿é—®çš„ç”¨æˆ·è®°åš0ï¼Œ ç”¨åç§»é‡ä½œä¸ºç”¨æˆ·çš„id

```bash
#setbit
setbit unique:users:20201106 1 1
setbit unique:users:20201106 6 1
setbit unique:users:20201106 11 1
setbit unique:users:20201106 15 1
setbit unique:users:20201106 19 1
```

![Untitled](redis%E6%96%B0%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%200283eaf46b524244b24bad15862290c5/Untitled%201.png)

```bash
#getbit
getbit unique:users:20201106 8 
#bitcount
bitcount unique:users:20201106 #è¿”å›5
#ä¸‹é¢æ“ä½œè®¡ç®—ç”¨æˆ·idåœ¨ç¬¬1ä¸ªå­—èŠ‚åˆ°ç¬¬3ä¸ªå­—èŠ‚ä¹‹é—´çš„ç‹¬ç«‹è®¿é—®ç”¨æˆ·æ•°
bitcount unique:users:20201106 1 3 #è¿”å›3ï¼Œå¯¹åº”çš„åç§»é‡ä½11ã€15ã€19

#bitop
#2020-11-04 æ—¥è®¿é—®ç½‘ç«™çš„userid=1,2,5,9ã€‚
setbit unique:users:20201104 1 1
setbit unique:users:20201104 2 1
setbit unique:users:20201104 5 1
setbit unique:users:20201104 9 1
#2020-11-03 æ—¥è®¿é—®ç½‘ç«™çš„userid=0,1,4,9ã€‚
setbit unique:users:20201103 0 1
setbit unique:users:20201103 1 1
setbit unique:users:20201103 4 1
setbit unique:users:20201103 9 1
#è®¡ç®—å‡ºä¸¤å¤©éƒ½è®¿é—®è¿‡ç½‘ç«™çš„ç”¨æˆ·æ•°é‡
bitop and unique:users:and:20201104_03 unique:users:20201103 unique:users:20201104
#unique:users:and:20201104_03æ˜¯[destkey]
```

- Bitmaps & set
    - ç›¸æ¯”seté›†åˆï¼ŒBitmapså ç”¨å†…å­˜å¾ˆå°‘ï¼Œé€‚åˆå­˜æ”¾æ—¥æ´»ç”¨æˆ·æ•°æ®
    - ä½†æ˜¯å½“æ¯å¤©æ—¥æ´»ç”¨æˆ·æ•°å¾ˆå°‘æ—¶ï¼Œä½¿ç”¨Bitmapså°±ä¸å¤ªåˆé€‚ï¼Œå› ä¸ºå¤§é‡æ•°æ®éƒ½æ˜¯0

# 2. **HyperLogLog**

## 2.1 ç®€ä»‹

- åŸºæ•°æ¦‚å¿µ
    - æ¯”å¦‚æ•°æ®é›† {1, 3, 5, 7, 5, 7, 8}ï¼Œ é‚£ä¹ˆè¿™ä¸ªæ•°æ®é›†çš„åŸºæ•°é›†ä¸º {1, 3, 5 ,7, 8}, åŸºæ•°(ä¸é‡å¤å…ƒç´ )ä¸º5
- Redis HyperLogLog æ˜¯ç”¨æ¥åšåŸºæ•°ç»Ÿè®¡çš„ç®—æ³•ï¼ŒHyperLogLog çš„ä¼˜ç‚¹æ˜¯ï¼Œåœ¨è¾“å…¥å…ƒç´ çš„æ•°é‡æˆ–è€…ä½“ç§¯éå¸¸éå¸¸å¤§æ—¶ï¼Œè®¡ç®—åŸºæ•°æ‰€éœ€çš„ç©ºé—´æ€»æ˜¯å›ºå®šçš„ã€å¹¶ä¸”æ˜¯å¾ˆå°çš„
- åœ¨Redis é‡Œé¢ï¼Œæ¯ä¸ª HyperLogLog é”®åªéœ€è¦èŠ±è´¹12 KBå†…å­˜ï¼Œå°±å¯ä»¥è®¡ç®—æ¥è¿‘ 2^64 ä¸ªä¸åŒå…ƒç´ çš„åŸºæ•°

<aside>
ğŸ“¢ å› ä¸º HyperLogLog åªä¼šæ ¹æ®è¾“å…¥å…ƒç´ æ¥è®¡ç®—åŸºæ•°ï¼Œè€Œä¸ä¼šå‚¨å­˜è¾“å…¥å…ƒç´ æœ¬èº«ï¼Œæ‰€ä»¥ HyperLogLog ä¸èƒ½åƒé›†åˆé‚£æ ·ï¼Œè¿”å›è¾“å…¥çš„å„ä¸ªå…ƒç´ 

</aside>

## 2.2 å‘½ä»¤

- `pfadd <key>< element> [element ...]` ï¼šæ·»åŠ æŒ‡å®šå…ƒç´ åˆ° HyperLogLog ä¸­
- `pfcount <key> [key ...]` ï¼šè®¡ç®—keyçš„è¿‘ä¼¼åŸºæ•°ï¼Œå¯ä»¥åˆå¹¶è®¡ç®—
- `pfmerge <destkey> <sourcekey> [sourcekey ...]` ï¼šå°†ä¸€ä¸ªæˆ–å¤šä¸ªHLLåˆå¹¶åçš„ç»“æœå­˜å‚¨åœ¨å¦ä¸€ä¸ªHLLä¸­

## 2.3 å®ä¾‹

```bash
#pfadd
pfadd hill1 "redis"
pfadd hill1 "mysql"
pfadd hill2 "redis"
#pfcount
pfcount hill1 #è¿”å›2
pfcount hill1 hill2 #è¿”å›2
#pfmerge
pfmerge hill3 hill1 hill2 #è¿”å›OK
pfcount hill3 #è¿”å›2
```