# äº‹åŠ¡æ“ä½œ

### äº‹åŠ¡æ¦‚å¿µ

- æ¦‚å¿µ
    - ä»€ä¹ˆæ˜¯äº‹åŠ¡
        - äº‹åŠ¡æ˜¯æ•°æ®åº“æ“ä½œæœ€åŸºæœ¬å•å…ƒï¼Œé€»è¾‘ä¸Šä¸€ç»„æ“ä½œï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œå¦‚æœæœ‰ä¸€ä¸ªå¤±è´¥æ‰€æœ‰æ“ä½œéƒ½å¤±è´¥
    - å…¸å‹åœºæ™¯ï¼šé“¶è¡Œè½¬è´¦
        - lucy è½¬è´¦100å…ƒ ç»™mary,lucyå°‘100ï¼Œmaryå¤š100
        
- äº‹åŠ¡å››ä¸ªç‰¹æ€§ï¼ˆACIDï¼‰
    - åŸå­æ€§
    - ä¸€è‡´æ€§
    - éš”ç¦»æ€§
    - æŒä¹…æ€§

### æ­å»ºäº‹åŠ¡æ“ä½œç¯å¢ƒ

- åˆ›å»ºæ•°æ®åº“è¡¨ï¼Œæ·»åŠ è®°å½•
    
    ![Untitled](./images/event/Untitled.png)
    
- åˆ›å»ºserviceï¼Œæ­å»ºdaoï¼Œå®Œæˆå¯¹è±¡åˆ›å»ºå’Œæ³¨å…¥å…³ç³»
    - serviceæ³¨å…¥daoï¼Œåœ¨daoæ³¨å…¥JdbcTemplateï¼Œåœ¨JdbcTemplateæ³¨å…¥DataSource
        
        ```java
        @Service
        public class UserService {
            //æ³¨å…¥dao
            @Autowired
            private UserDao userDao;
        }
        ```
        
        ```java
        @Repository
        public class UserDaoImpl implements UserDao {
            @Autowired
            private JdbcTemplate jdbcTemplate;
        }
        ```
        
    - åœ¨daoåˆ›å»ºä¸¤ä¸ªæ–¹æ³•ï¼šå¤šé’±å’Œå°‘é’±çš„æ–¹æ³•ï¼Œåœ¨serviceåˆ›å»ºæ–¹æ³•ï¼ˆè½¬è´¦çš„æ–¹æ³•ï¼‰
        
        ```java
        @Repository
        public class UserDaoImpl implements UserDao {
        
            @Autowired
            private JdbcTemplate jdbcTemplate;
        
            //lucyè½¬è´¦100ç»™mary
            //å°‘é’±
            @Override
            public void reduceMoney() {
                String sql = "update t_account set money=money-? where username=?";
                jdbcTemplate.update(sql,100,"lucy");
            }
        
            //å¤šé’±
            @Override
            public void addMoney() {
                String sql = "update t_account set money=money+? where username=?";
                jdbcTemplate.update(sql,100,"mary");
            }
        }
        ```
        
        ```java
        @Service
        public class UserService {
            //æ³¨å…¥dao
            @Autowired
            private UserDao userDao;
            //è½¬è´¦çš„æ–¹æ³•
            public void accountMoney() {
                    //lucyå°‘100
                    userDao.reduceMoney();
        
                    //maryå¤š100
                    userDao.addMoney();
            }
        }
        ```
        
        <aside>
        ğŸ“¢ ä¸Šé¢çš„ä»£ç ï¼Œå¦‚æœæ­£å¸¸æ‰§è¡Œæ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸åˆ™ä¼šå‡ºç°é—®é¢˜
        
        </aside>
        
- äº‹åŠ¡æ“ä½œè¿‡ç¨‹
    
    ```java
    public void accountMoney() {
            try {
                //ç¬¬ä¸€æ­¥ å¼€å¯äº‹åŠ¡
    
                //ç¬¬äºŒæ­¥ è¿›è¡Œä¸šåŠ¡æ“ä½œ
                //lucyå°‘100
                userDao.reduceMoney();
    
                //æ¨¡æ‹Ÿå¼‚å¸¸
                int i = 10/0;
    
                //maryå¤š100
                userDao.addMoney();
    
                //ç¬¬ä¸‰æ­¥ æ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œæäº¤äº‹åŠ¡
            }catch(Exception e) {
                //ç¬¬å››æ­¥ å‡ºç°å¼‚å¸¸ï¼Œäº‹åŠ¡å›æ»š
            }
        }
    ```
    

### Spring äº‹åŠ¡ç®¡ç†ä»‹ç»

- äº‹åŠ¡æ·»åŠ åˆ°JavaEEä¸‰å±‚ç»“æ„é‡Œé¢Serviceå±‚ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰
- Springäº‹åŠ¡ç®¡ç†æ“ä½œï¼šç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç† & å£°æ˜å¼äº‹åŠ¡ç®¡ç†
- å£°æ˜å¼äº‹åŠ¡ç®¡ç†
    - åŸºäºæ³¨è§£æ–¹å¼
    - åŸºäºxmlé…ç½®æ–‡ä»¶æ–¹å¼

<aside>
ğŸ“¢ åœ¨Springè¿›è¡Œå£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼Œåº•å±‚ä½¿ç”¨AOPåŸç†

</aside>

- Springäº‹åŠ¡ç®¡ç†API
    - æä¾›ä¸€ä¸ªæ¥å£ï¼Œä»£è¡¨äº‹åŠ¡ç®¡ç†å™¨ï¼Œè¿™ä¸ªæ¥å£é’ˆå¯¹ä¸åŒçš„æ¡†æ¶æä¾›ä¸åŒçš„å®ç°ç±»
    
    ![Untitled](./images/event/Untitled%201.png)
    

### æ³¨è§£å£°æ˜å¼äº‹åŠ¡ç®¡ç†

- åœ¨springé…ç½®æ–‡ä»¶é…ç½®äº‹åŠ¡ç®¡ç†å™¨
    
    ```xml
    <!--åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨-->
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <!--æ³¨å…¥æ•°æ®æº-->
        <property name="dataSource" ref="dataSource"></property>
    </bean>
    
    ```
    
- åœ¨springé…ç½®æ–‡ä»¶ï¼Œå¼€å¯äº‹åŠ¡æ³¨è§£
    - åœ¨springé…ç½®æ–‡ä»¶å¼•å…¥åç§°ç©ºé—´ tx
        
        ```xml
        <!--åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨-->
            <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
                <!--æ³¨å…¥æ•°æ®æº-->
                <property name="dataSource" ref="dataSource"></property>
        	  </bean>
        ```
        
    - å¼€å¯äº‹åŠ¡æ³¨è§£
        
        ```xml
        <beans xmlns="http://www.springframework.org/schema/beans"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:context="http://www.springframework.org/schema/context"
               xmlns:aop="http://www.springframework.org/schema/aop"
               xmlns:tx="http://www.springframework.org/schema/tx"
               xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                                http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
                                http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
                                http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">
        ```
        
- åœ¨serviceç±»ä¸Šé¢ï¼ˆæˆ–è€…serviceç±»é‡Œé¢æ–¹æ³•ä¸Šé¢ï¼‰æ·»åŠ äº‹åŠ¡æ³¨è§£
    - @Transactionalï¼Œè¿™ä¸ªæ³¨è§£æ·»åŠ åˆ°ç±»ä¸Šé¢ï¼Œä¹Ÿå¯ä»¥æ·»åŠ æ–¹æ³•ä¸Šé¢
        - å¦‚æœæŠŠè¿™ä¸ªæ³¨è§£æ·»åŠ ç±»ä¸Šé¢ï¼Œè¿™ä¸ªç±»é‡Œé¢æ‰€æœ‰çš„æ–¹æ³•éƒ½æ·»åŠ äº‹åŠ¡
        - å¦‚æœæŠŠè¿™ä¸ªæ³¨è§£æ·»åŠ æ–¹æ³•ä¸Šé¢ï¼Œä¸ºè¿™ä¸ªæ–¹æ³•æ·»åŠ äº‹åŠ¡
        
        ```java
        @Service 
        @Transactional 
        public class UserService {...}
        ```
        

### å£°æ˜å¼äº‹åŠ¡ç®¡ç†å‚æ•°é…ç½®

- åœ¨serviceç±»ä¸Šé¢æ·»åŠ æ³¨è§£@Transactionalï¼Œåœ¨è¿™ä¸ªæ³¨è§£é‡Œé¢å¯ä»¥é…ç½®äº‹åŠ¡ç›¸å…³å‚æ•°
    - propagationï¼šäº‹åŠ¡ä¼ æ’­è¡Œä¸º
        
        ![Untitled](./images/event/Untitled%202.png)
        
    - ioslationï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«
        - ä¸‰ä¸ªè¯»é—®é¢˜
            - è„è¯»ï¼šä¸€ä¸ªæœªæäº¤äº‹åŠ¡è¯»å–åˆ°å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡çš„æ•°æ®
            - ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªæœªæäº¤äº‹åŠ¡è¯»å–åˆ°å¦ä¸€æäº¤äº‹åŠ¡ä¿®æ”¹æ•°æ®
            - è™šè¯»ï¼šä¸€ä¸ªæœªæäº¤äº‹åŠ¡è¯»å–åˆ°å¦ä¸€æäº¤äº‹åŠ¡æ·»åŠ æ•°æ®
            
            ![Untitled](./images/event/Untitled%203.png)
            
    - timeoutï¼šè¶…æ—¶æ—¶é—´
        - äº‹åŠ¡éœ€è¦åœ¨ä¸€å®šæ—¶é—´å†…è¿›è¡Œæäº¤ï¼Œå¦‚æœä¸æäº¤è¿›è¡Œå›æ»š
        - é»˜è®¤å€¼æ˜¯ -1 ï¼Œå³ä¸å…è®¸è¶…æ—¶
    - readOnlyï¼šæ˜¯å¦åªè¯»
        - é»˜è®¤å€¼falseï¼Œè¡¨ç¤ºå¯ä»¥æŸ¥è¯¢ï¼Œå¯ä»¥æ·»åŠ ä¿®æ”¹åˆ é™¤æ“ä½œ
        - è®¾ç½®æˆtrueï¼Œåªèƒ½æŸ¥è¯¢
    - rollbackForï¼šå›æ»š
        - è®¾ç½®å‡ºç°å“ªäº›å¼‚å¸¸è¿›è¡Œäº‹åŠ¡å›æ»š
    - noRollbackForï¼šä¸å›æ»š
        - è®¾ç½®å‡ºç°å“ªäº›å¼‚å¸¸ä¸è¿›è¡Œäº‹åŠ¡å›æ»š

### XML å£°æ˜å¼äº‹åŠ¡ç®¡ç†

- ç¬¬ä¸€æ­¥ é…ç½®äº‹åŠ¡ç®¡ç†å™¨
- ç¬¬äºŒæ­¥ é…ç½®é€šçŸ¥
- ç¬¬ä¸‰æ­¥ é…ç½®åˆ‡å…¥ç‚¹å’Œåˆ‡é¢
    
    ```xml
    <!--1 åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨-->
        <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
            <!--æ³¨å…¥æ•°æ®æº-->
            <property name="dataSource" ref="dataSource"></property>
        </bean>
    
        <!--2 é…ç½®é€šçŸ¥-->
        <tx:advice id="txadvice">
            <!--é…ç½®äº‹åŠ¡å‚æ•°-->
            <tx:attributes>
                <!--æŒ‡å®šå“ªç§è§„åˆ™çš„æ–¹æ³•ä¸Šé¢æ·»åŠ äº‹åŠ¡-->
                <tx:method name="accountMoney" propagation="REQUIRED"/>
                <!--<tx:method name="account*"/>-->
            </tx:attributes>
        </tx:advice>
    
        <!--3 é…ç½®åˆ‡å…¥ç‚¹å’Œåˆ‡é¢-->
        <aop:config>
            <!--é…ç½®åˆ‡å…¥ç‚¹-->
            <aop:pointcut id="pt" expression="execution(* com.atguigu.spring5.service.UserService.*(..))"/>
            <!--é…ç½®åˆ‡é¢-->
            <aop:advisor advice-ref="txadvice" pointcut-ref="pt"/>
        </aop:config>
    ```
    

### å®Œå…¨æ³¨è§£å£°æ˜å¼äº‹åŠ¡ç®¡ç†

- åˆ›å»ºé…ç½®ç±»ï¼Œä½¿ç”¨é…ç½®ç±»æ›¿ä»£xmlé…ç½®æ–‡ä»¶
    
    ```java
    @Configuration //é…ç½®ç±»
    @ComponentScan(basePackages = "com.atguigu") //ç»„ä»¶æ‰«æ
    @EnableTransactionManagement //å¼€å¯äº‹åŠ¡
    public class TxConfig {
    
        //åˆ›å»ºæ•°æ®åº“è¿æ¥æ± 
        @Bean
        public DruidDataSource getDruidDataSource() {
            DruidDataSource dataSource = new DruidDataSource();
            dataSource.setDriverClassName("com.mysql.jdbc.Driver");
            dataSource.setUrl("jdbc:mysql:///user_db");
            dataSource.setUsername("root");
            dataSource.setPassword("root");
            return dataSource;
        }
    
        //åˆ›å»ºJdbcTemplateå¯¹è±¡
        @Bean
        public JdbcTemplate getJdbcTemplate(DataSource dataSource) {
            //åˆ°iocå®¹å™¨ä¸­æ ¹æ®ç±»å‹æ‰¾åˆ°dataSource
            JdbcTemplate jdbcTemplate = new JdbcTemplate();
            //æ³¨å…¥dataSource
            jdbcTemplate.setDataSource(dataSource);
            return jdbcTemplate;
        }
    
        //åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨
        @Bean
        public DataSourceTransactionManager getDataSourceTransactionManager(DataSource dataSource) {
            DataSourceTransactionManager transactionManager = new DataSourceTransactionManager();
            transactionManager.setDataSource(dataSource);
            return transactionManager;
        }
    }
    ```